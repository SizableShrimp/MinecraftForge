--- a/net/minecraft/world/inventory/AbstractContainerMenu.java
+++ b/net/minecraft/world/inventory/AbstractContainerMenu.java
@@ -43,8 +_,8 @@
    }
 
    protected static boolean m_38889_(ContainerLevelAccess p_38890_, Player p_38891_, Block p_38892_) {
-      return p_38890_.m_39299_((p_38916_, p_38917_) -> {
-         return !p_38916_.m_8055_(p_38917_).m_60713_(p_38892_) ? false : p_38891_.m_20275_((double)p_38917_.m_123341_() + 0.5D, (double)p_38917_.m_123342_() + 0.5D, (double)p_38917_.m_123343_() + 0.5D) <= 64.0D;
+      return p_38890_.m_39299_((p_216960_2_, p_216960_3_) -> {
+         return !p_216960_2_.m_8055_(p_216960_3_).m_60713_(p_38892_) ? false : p_38891_.m_20275_((double)p_216960_3_.m_123341_() + 0.5D, (double)p_216960_3_.m_123342_() + 0.5D, (double)p_216960_3_.m_123343_() + 0.5D) <= 64.0D;
       }, true);
    }
 
@@ -117,9 +_,11 @@
          ItemStack itemstack = this.f_38839_.get(i).m_7993_();
          ItemStack itemstack1 = this.f_38841_.get(i);
          if (!ItemStack.m_41728_(itemstack1, itemstack)) {
+            boolean clientStackChanged = !itemstack1.equals(itemstack, true);
             ItemStack itemstack2 = itemstack.m_41777_();
             this.f_38841_.set(i, itemstack2);
 
+            if (clientStackChanged)
             for(ContainerListener containerlistener : this.f_38848_) {
                containerlistener.m_7934_(this, i, itemstack2);
             }
@@ -497,14 +_,15 @@
             ItemStack itemstack = slot.m_7993_();
             if (!itemstack.m_41619_() && m_38910_(p_38904_, itemstack)) {
                int j = itemstack.m_41613_() + p_38904_.m_41613_();
-               if (j <= p_38904_.m_41741_()) {
+               int maxSize = Math.min(slot.m_6641_(), p_38904_.m_41741_());
+               if (j <= maxSize) {
                   p_38904_.m_41764_(0);
                   itemstack.m_41764_(j);
                   slot.m_6654_();
                   flag = true;
-               } else if (itemstack.m_41613_() < p_38904_.m_41741_()) {
-                  p_38904_.m_41774_(p_38904_.m_41741_() - itemstack.m_41613_());
-                  itemstack.m_41764_(p_38904_.m_41741_());
+               } else if (itemstack.m_41613_() < maxSize) {
+                  p_38904_.m_41774_(maxSize - itemstack.m_41613_());
+                  itemstack.m_41764_(maxSize);
                   slot.m_6654_();
                   flag = true;
                }
@@ -605,7 +_,7 @@
          p_38925_.m_41764_(1);
          break;
       case 2:
-         p_38925_.m_41764_(p_38925_.m_41720_().m_41459_());
+         p_38925_.m_41764_(p_38925_.m_41741_());
       }
 
       p_38925_.m_41769_(p_38926_);
